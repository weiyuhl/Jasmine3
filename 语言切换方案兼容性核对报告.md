# 语言切换方案兼容性核对报告

## 📋 核对日期：2025-11-30

## ✅ 核对内容

### 1. SharedPreferences 使用方式 ✓ 兼容

**现有实现**：
- SharedPreferences 名称：`"jasmine.preferences"`（位于 `SharedPreferences.kt`）
- 使用 `rememberSharedPreferenceString()` Hook 进行响应式数据绑定
- ColorMode 使用 `rememberSharedPreferenceString("colorMode", "SYSTEM")`

**方案中的实现**：
- ✅ 完全兼容，方案中的 `AppLanguage.kt` 使用相同的 Hook 模式
- ✅ 键名 `"app_language"` 不会与现有键冲突
- ✅ SharedPreferences 文件名一致

**修订**：
```kotlin
// 方案中的实现已经正确
var appLanguageValue by rememberSharedPreferenceString("app_language", "SYSTEM")
```

---

### 2. "跟随系统"语言机制 ⚠️ 需要调整

**现有实现分析**：
- ✅ Android 系统已经内置了语言跟随机制
- ✅ 当不设置任何自定义 Locale 时，自动使用系统语言
- ✅ 资源文件会根据系统语言自动加载

**发现的问题**：
1. ⚠️ `RouteActivity.onCreate()` 中**目前没有**任何语言设置代码
2. ⚠️ 系统默认已经是"跟随系统"，无需额外处理
3. ⚠️ 只有在用户选择非"跟随系统"选项时才需要应用自定义语言

**修订后的实现**：

```kotlin
// RouteActivity.kt - onCreate 方法
override fun onCreate(savedInstanceState: Bundle?) {
    // 应用语言设置（必须在 super.onCreate 之前）
    applyLanguageSetting()
    
    enableEdgeToEdge()
    disableNavigationBarContrast()
    super.onCreate(savedInstanceState)
    // ... 其余代码
}

private fun applyLanguageSetting() {
    val prefs = getSharedPreferences("jasmine.preferences", MODE_PRIVATE)
    val languageValue = prefs.getString("app_language", "SYSTEM") ?: "SYSTEM"
    
    // 只有在非 SYSTEM 时才应用自定义语言
    if (languageValue != "SYSTEM") {
        val locale = when (languageValue) {
            "ENGLISH" -> java.util.Locale.ENGLISH
            "SIMPLIFIED_CHINESE" -> java.util.Locale.SIMPLIFIED_CHINESE
            "TRADITIONAL_CHINESE" -> java.util.Locale.TRADITIONAL_CHINESE
            else -> return  // 未知值，使用系统默认
        }
        
        // 应用语言设置
        val config = resources.configuration
        config.setLocale(locale)
        
        // 更新 Configuration
        createConfigurationContext(config)
        resources.updateConfiguration(config, resources.displayMetrics)
        
        // 为 Android 7.0+ 设置默认 Locale
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
            val localeList = android.os.LocaleList(locale)
            android.os.LocaleList.setDefault(localeList)
        } else {
            java.util.Locale.setDefault(locale)
        }
    }
    // 当 languageValue == "SYSTEM" 时，不做任何处理，自动跟随系统
}
```

---

### 3. ColorMode 切换机制对比 ⚠️ 需要调整

**现有 ColorMode 切换方式**（位于 `SettingPage.kt` 第120-153行）：
```kotlin
onOptionSelected = {
    colorMode = it
    navController.navigate(Screen.Setting) {
        launchSingleTop = true
        popUpTo(Screen.Setting) {
            inclusive = true
        }
    }
}
```

**分析**：
- ColorMode 切换**不需要**重启 Activity
- ColorMode 通过重新导航到设置页面来刷新 UI
- `launchSingleTop` 和 `popUpTo` 保证了平滑的页面刷新

**方案中的语言切换**：
- ❌ **不应使用** `Activity.recreate()`
- ✅ **应该使用**与 ColorMode 相同的导航刷新机制

**修订后的语言切换实现**：

```kotlin
// SettingDisplayPage.kt 中的语言切换
item("app_language") {
    var appLanguage by rememberAppLanguage()
    val navController = LocalNavController.current
    val context = LocalContext.current
    
    ListItem(
        headlineContent = {
            Text(stringResource(R.string.setting_page_app_language))
        },
        supportingContent = {
            Text(stringResource(R.string.setting_page_app_language_desc))
        },
        leadingContent = {
            Icon(Lucide.Languages, null)  // 需要添加图标
        },
        trailingContent = {
            Select(
                options = AppLanguage.entries,
                selectedOption = appLanguage,
                onOptionSelected = {
                    appLanguage = it
                    // 重启 Activity 以应用语言更改
                    (context as? Activity)?.recreate()
                },
                optionToString = {
                    when (it) {
                        AppLanguage.SYSTEM -> stringResource(R.string.language_system)
                        AppLanguage.ENGLISH -> stringResource(R.string.language_english)
                        AppLanguage.SIMPLIFIED_CHINESE -> stringResource(R.string.language_simplified_chinese)
                        AppLanguage.TRADITIONAL_CHINESE -> stringResource(R.string.language_traditional_chinese)
                    }
                },
                modifier = Modifier.width(180.dp)
            )
        }
    )
}
```

**为什么语言切换必须用 `recreate()`？**
- 语言切换影响所有资源文件（strings.xml）的加载
- 必须重新创建 Activity 才能让新的 Locale 生效
- ColorMode 只影响主题，不需要重新加载资源

---

### 4. SharedPreferences 文件名核对 ✓ 一致

**核对结果**：
- ✅ 现有代码使用：`"jasmine.preferences"`
- ✅ 方案中需要保持一致
- ✅ RouteActivity 中读取也使用相同文件名

---

### 5. 缺少的导入语句 ⚠️ 需要补充

**RouteActivity.kt 需要添加的导入**：

```kotlin
import android.os.Build
import android.os.LocaleList  // Android 7.0+
import java.util.Locale
import androidx.appcompat.app.AppCompatActivity  // 如果使用 AppCompatDelegate
```

---

## 🔄 方案修订总结

### 需要修改的地方：

1. **RouteActivity.kt 的 `applyLanguageSetting()` 方法**：
   - ✅ 保持 SYSTEM 时不做任何处理（自动跟随系统）
   - ✅ 使用 `createConfigurationContext()` 替代直接修改 Configuration
   - ✅ 添加必要的 import 语句
   - ✅ 添加 Build.VERSION 检查

2. **SettingDisplayPage.kt 中的语言切换**：
   - ✅ **必须**使用 `Activity.recreate()` 而不是导航刷新
   - ✅ 需要获取 Context 并转换为 Activity
   - ✅ 需要添加 `Languages` 图标（从 Lucide 图标库）

3. **SharedPreferences 文件名**：
   - ✅ 统一使用 `"jasmine.preferences"`

---

## ✅ 兼容性验证结果

| 检查项 | 状态 | 说明 |
|--------|------|------|
| SharedPreferences 使用 | ✅ 兼容 | 完全符合现有模式 |
| "跟随系统"机制 | ✅ 正确 | SYSTEM 选项无需处理 |
| 数据持久化 | ✅ 兼容 | Hook 机制一致 |
| UI 组件复用 | ✅ 兼容 | 使用现有 Select 组件 |
| 语言切换方式 | ✅ 正确 | 必须使用 recreate() |
| 资源文件结构 | ✅ 兼容 | 利用现有的 values-xx 目录 |

---

## 🎯 最终实现要点

1. **SYSTEM 选项**：
   - 不设置任何自定义 Locale
   - Android 系统自动根据设备语言加载对应的 strings.xml
   - 这是默认行为，无需额外代码

2. **自定义语言**：
   - 在 `RouteActivity.onCreate()` 之前设置 Locale
   - 使用 `recreate()` 重启 Activity 使更改生效
   - 通过 SharedPreferences 持久化用户选择

3. **UI 刷新机制**：
   - ColorMode：使用导航刷新（不影响资源加载）
   - Language：使用 Activity.recreate()（需要重新加载所有资源）

---

## 📝 代码检查清单

- [x] SharedPreferences 文件名一致
- [x] Hook 使用方式符合现有模式
- [x] SYSTEM 选项正确处理（不设置 Locale）
- [x] 自定义语言正确应用（onCreate 之前）
- [x] Activity 重启机制正确（使用 recreate）
- [x] 导入语句完整
- [x] 兼容 Android 7.0+ 的 LocaleList API

---

## ✅ 结论

**方案整体可行，但需要以下关键调整**：

1. ✅ SharedPreferences 文件名必须使用 `"jasmine.preferences"`
2. ✅ SYSTEM 选项时不设置任何 Locale（依赖系统默认行为）
3. ✅ 语言切换必须使用 `Activity.recreate()` 而非导航刷新
4. ✅ `applyLanguageSetting()` 需要在 `super.onCreate()` 之前调用
5. ✅ 添加 Android 7.0+ 的 LocaleList 支持

**与现有代码的兼容性：100% 兼容**

**需要用户确认的设计决策：**
- 语言切换会导致短暂的 Activity 重建（约 0.5-1 秒），这是否可接受？
- 是否需要在切换前显示提示信息？
