功能概览

- 生成对话建议的核心流程：在一次消息生成完成后自动提取最近上下文，用专用模型和提示词生成建议，写入对话的 chatSuggestions ，UI 底部展示为可点击的候选回复。
- 主要组件：服务层生成与保存、设置项（模型/提示词）、数据持久化、UI 展示与点击回填。
触发路径

- 自动触发位置：在聊天生成完成的收尾阶段并发生成标题与建议，二者完成后解除会话“引用”。 app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:435-446
  - 并发调用： launch { generateSuggestion(conversationId, finalConversation) } ChatService.kt:442
- 手动入口（供 VM 调用）： ChatVM.generateSuggestion(conversation) 封装到 VM 的 viewModelScope 中调用服务层方法。 app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:513-516
生成实现

- 服务方法： ChatService.generateSuggestion(conversationId, conversation) 使用设置中的建议模型与提示词生成文本，按行切分为建议。 app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:666-709
  - 读取设置： settingsStore.settingsFlow.first() ，取 suggestionModelId 与 suggestionPrompt 。 ChatService.kt:668-683
  - 生成请求：包装成一条 UIMessage.user ，提示词占位符 {locale} {content} 由 applyPlaceholders 替换。 ChatService.kt:681-686 ；占位符替换实现见 app/src/main/java/com/lhzkml/jasmine/utils/StringUtils.kt:37-45
  - 生成参数： TextGenerationParams(model = model, temperature = 1.0f, thinkingBudget = 0) ，不启用思考流量。 ChatService.kt:688-693
  - 结果处理：按换行拆分、 trim() 、过滤空行，取最多 10 条，保存回会话。 ChatService.kt:694-705
- 上下文选择：取当前消息序列，按 truncateIndex 截断后再 takeLast(8) ，合并为 content 传入提示词。 ChatService.kt:683-686
配置项

- 默认提示词： DEFAULT_SUGGESTION_PROMPT ，约束 3~5 条建议、使用 {locale} 语言、每条不超过 10 字等规则。 app/src/main/java/com/lhzkml/jasmine/data/ai/prompts/Suggestion.kt:3-18
- 设置 UI：在“模型设置”页的“建议模型”卡片中选择模型，并可弹出底部面板编辑提示词或一键重置为默认。 app/src/main/java/com/lhzkml/jasmine/ui/pages/setting/SettingModelPage.kt:202-295
  - 文案键： setting_model_page_suggestion_model 、 setting_model_page_suggestion_model_desc 、 setting_model_page_prompt 、 setting_model_page_suggestion_prompt_vars 、 setting_model_page_reset_to_default （引用处见 SettingModelPage.kt:210-216, 262-266, 289 ）
- 设置存取： Settings 含 suggestionModelId 、 suggestionPrompt 字段；偏好键分别为 SUGGESTION_MODEL 、 SUGGESTION_PROMPT 。 app/src/main/java/com/lhzkml/jasmine/data/datastore/PreferencesStore.kt:73-79, 128-135, 260-266, 304-321
数据与持久化

- 会话模型字段： Conversation.chatSuggestions: List<String> 。 app/src/main/java/com/lhzkml/jasmine/data/model/Conversation.kt:33
- Room 实体： ConversationEntity.chatSuggestions: String （JSON 存储，默认值 "[]" ）。 app/src/main/java/com/lhzkml/jasmine/data/db/entity/ConversationEntity.kt:23-26
- 仓库映射：
  - 保存时编码： JsonInstant.encodeToString(conversation.chatSuggestions) 。 app/src/main/java/com/lhzkml/jasmine/data/repository/ConversationRepository.kt:143-147
  - 读取时解码： JsonInstant.decodeFromString(conversationEntity.chatSuggestions) 。 ConversationRepository.kt:160-165
  - 轻量查询结果说明：列表查询不包含 nodes 与 suggestions 字段。 ConversationRepository.kt:199-201
UI 展示与交互

- 展示条件：列表项底部在非滚动捕获状态且建议非空时显示。 app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatList.kt:420-427
- 行组件： ChatSuggestionsRow 横向列表，点击某条建议即触发传入回调。 ChatList.kt:621-650
- 点击行为：将建议文案填入输入框，退出编辑态。 app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatPage.kt:401-404
边界与清空

- 生成开始前会清空旧建议： updateConversation(... chatSuggestions = emptyList()) 。 ChatService.kt:672-675
- 完成消息补全时也会重置建议： conversation.copy(chatSuggestions = emptyList()) 。 ChatService.kt:356-358
- 主动截断消息历史时清空建议： handleMessageTruncate 将 chatSuggestions 设为 emptyList() 。 app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:331-336

注意点与建议

- 长度约束未强制：提示词要求“每条不超过 10 字”，但服务层未在解析时裁剪长度；若需要硬限制可在拆分后做 filter { it.codePointCount(...) <= 10 } 或 take(10) 裁剪。当前行为是“最多 10 条，允许任意长度”。
- 语言占位 {locale} 来源： Locale.getDefault().displayName ，不同系统语言下显示名可能带地区或中文括号，可能与模型期待的语言标签不完全一致；若需更精确可改为 languageTag 。
- 上下文窗口：仅取最近 8 条（截断后的）消息摘要用于生成，超出部分不会影响建议；可视需求调整数量。
重要位置索引

- 触发并发： app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:441-443
- 核心生成： app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:666-709
- VM 包装： app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:513-516
- 默认提示词： app/src/main/java/com/lhzkml/jasmine/data/ai/prompts/Suggestion.kt:3-18
- 设置页（模型/提示词）： app/src/main/java/com/lhzkml/jasmine/ui/pages/setting/SettingModelPage.kt:202-295
 

**删除清单**
- 服务层
  - 删除 `generateSuggestion` 实现与所有调用：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:666-709`、并发触发 `app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:441-443`。
  - 删除建议清空逻辑：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:356-358, 672-675`。
  - 保留标题生成：并发触发 `generateTitle`：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:441`，生成实现：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:618-663`；保留会话引用管理 `addConversationReference/removeConversationReference`。
- 视图模型
  - 删除 `ChatVM.generateSuggestion(conversation)`：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:513-516`。
  - 从 `handleMessageTruncate` 去除对 `chatSuggestions` 的处理：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:331-336`。
  - 保留标题生成入口：`ChatVM.generateTitle(...)` 与其调用：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatVM.kt:506-509`、`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatDrawer.kt:189`、`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ConversationList.kt:381`。
- UI
  - 删除聊天页建议条：移除 `ChatSuggestionsRow` 组件与展示条件：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatList.kt:421-427, 621-650`。
  - 删除 `ChatList` 的 `onClickSuggestion` 参数及传递：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatList.kt:121, 155-159, 178-181`。
  - 删除 `ChatPage` 传入的 `onClickSuggestion` 回调：`app/src/main/java/com/lhzkml/jasmine/ui/pages/chat/ChatPage.kt:401-404`。
  - 同步清理签名参数：删除 `ChatList` 顶层函数签名中的 `onClickSuggestion: (String) -> Unit = {}` 以及 `ChatListNormal` 的必选参数项，避免悬空引用。
- 设置与提示词
  - 删除默认提示词文件：`app/src/main/java/com/lhzkml/jasmine/data/ai/prompts/Suggestion.kt:3-18`。
  - 设置页移除“建议模型”卡片与提示词编辑：删除 `DefaultSuggestionModelSetting` 及其入口：`app/src/main/java/com/lhzkml/jasmine/ui/pages/setting/SettingModelPage.kt:88-89, 202-295`。
  - 同步清理图标与导入：删除 `SettingModelPage.kt` 中与建议卡片相关的 `Lucide.MessageSquareMore` 图标使用及其 import，避免编译警告（`app/src/main/java/com/lhzkml/jasmine/ui/pages/setting/SettingModelPage.kt:42`）。
  - 保留标题相关设置：`Settings.titleModelId`、`Settings.titlePrompt` 与 `DEFAULT_TITLE_PROMPT` 的引用；保留标题设置卡片 `DefaultTitleModelSetting`：`app/src/main/java/com/lhzkml/jasmine/ui/pages/setting/SettingModelPage.kt:296-387`。
- 设置存取
  - 删除设置项字段与偏好键：`Settings.suggestionModelId`、`Settings.suggestionPrompt` 及对应的 `SUGGESTION_MODEL`、`SUGGESTION_PROMPT` 读取与写入：`app/src/main/java/com/lhzkml/jasmine/data/datastore/PreferencesStore.kt:73-79, 128-135, 260-266, 319-321`。
  - 删除对 `DEFAULT_SUGGESTION_PROMPT` 的导入与引用：`PreferencesStore.kt:25, 133, 320`、`SettingModelPage.kt:284-289`。
74→
75→**保留项（与标题生成共用）**
76→- 服务与管线：保留 `ChatService.generateTitle` 及其并发触发与引用管理，避免影响标题生成流程：
77→  - 并发触发：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:441`（保留 `launch { generateTitle(conversationId, finalConversation) }`）。
78→  - 生成实现：`app/src/main/java/com/lhzkml/jasmine/service/ChatService.kt:618-663`。
79→- 提示词与设置：保留标题相关提示词与设置项：
80→  - `Settings.titleModelId` 与 `Settings.titlePrompt`：`app/src/main/java/com/lhzkml/jasmine/data/datastore/PreferencesStore.kt:314, 316`。
81→  - `DEFAULT_TITLE_PROMPT`：`app/src/main/java/com/lhzkml/jasmine/data/ai/prompts/Title.kt`（若存在于同目录、与建议提示词同类）。
82→- 共享工具与组件（通用依赖，不应删除）：
83→  - `ProviderManager.getProviderByType` 与 `ProviderSetting`/`Model` 数据结构：`ai/src/main/java/com/lhzkml/ai/provider/Provider.kt`、`ai/src/main/java/com/lhzkml/ai/provider/Model.kt`。
84→  - `TextGenerationParams`：`ai/src/main/java/com/lhzkml/ai/provider/Provider.kt`（与标题、建议共同使用）。
85→  - `UIMessage.user(...)` 与 `applyPlaceholders(...)`：`app/src/main/java/com/lhzkml/jasmine/utils/StringUtils.kt:37-45`。
86→  - 设置页通用文案键：`setting_model_page_prompt`、`setting_model_page_reset_to_default`（标题/翻译等模块复用）。

**多语言文案清理**
- 移除建议模型相关字符串键（保留通用键与共享键，如 `setting_model_page_reset_to_default` 与 `setting_model_page_suggestion_prompt_vars`）：
  - 英文：移除 `setting_model_page_suggestion_model`、`setting_model_page_suggestion_model_desc`（`app/src/main/res/values/strings.xml:115, 121`）；保留 `setting_model_page_suggestion_prompt_vars`（被标题设置页描述复用，见 `SettingModelPage.kt:353-358`）。
  - 简体中文：移除 `setting_model_page_suggestion_model`、`setting_model_page_suggestion_model_desc`（`app/src/main/res/values-zh/strings.xml:401-402`）；保留 `setting_model_page_suggestion_prompt_vars`（`values-zh:403`）。
  - 繁体中文：移除 `setting_model_page_suggestion_model`、`setting_model_page_suggestion_model_desc`（`app/src/main/res/values-zh-rTW/strings.xml:401-402`）；保留 `setting_model_page_suggestion_prompt_vars`（`values-zh-rTW:403`）。

**验证与回归**
- 构建与静态检查：
  - 执行 `gradlew build` 或 `gradlew assembleDebug`，确保编译通过。
- 运行验证：
  - 聊天页面不再显示建议条；
  - 设置页没有“建议模型”卡片与提示词编辑入口；
  - 发送/编辑/截断上下文等流程正常。
- 关键词核查（确保全局 0 引用）：
  - `generateSuggestion`、`DEFAULT_SUGGESTION_PROMPT`、`suggestionModelId`、`suggestionPrompt`、`onClickSuggestion`。

**风险与注意**
- 保留通用提示词复位键 `setting_model_page_reset_to_default`，其它模块仍在使用。
