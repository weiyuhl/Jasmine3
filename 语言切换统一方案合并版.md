# jasmine è¯­è¨€åˆ‡æ¢ç»Ÿä¸€æ–¹æ¡ˆï¼ˆåˆå¹¶ç‰ˆï¼‰

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°ä¸ç›®æ ‡

1. æ‰‹åŠ¨è¯­è¨€é€‰æ‹©ï¼šç”¨æˆ·å¯åœ¨è®¾ç½®é¡µé¢é€‰æ‹©åº”ç”¨ç•Œé¢è¯­è¨€ã€‚
2. æ”¯æŒè¯­è¨€ï¼š
   - ğŸ‡¬ğŸ‡§ Englishï¼ˆè‹±è¯­ï¼‰
   - ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡
   - ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡
   - ğŸŒ è·Ÿéšç³»ç»Ÿï¼ˆé»˜è®¤ï¼‰
3. æŒä¹…åŒ–å­˜å‚¨ï¼šç”¨æˆ·é€‰æ‹©åœ¨åº”ç”¨é‡å¯åä¿æŒã€‚
4. å³æ—¶ç”Ÿæ•ˆï¼šåˆ‡æ¢è¯­è¨€åé€šè¿‡ Activity é‡å»ºç«‹å³ç”Ÿæ•ˆã€‚

---
## ğŸ” ç°æœ‰ç³»ç»Ÿè¯­è¨€å“åº”æœºåˆ¶ï¼ˆæ·±åº¦åˆ†æç»“è®ºï¼‰

### AndroidManifest.xml é…ç½®

å½“å‰é…ç½®æœªåŒ…å« `locale`ï¼š

```xml
android:configChanges="keyboardHidden|orientation|screenSize"
```

å› æ­¤ï¼š
- å½“ç³»ç»Ÿè¯­è¨€æ”¹å˜æ—¶ï¼ŒAndroid ä¼šè‡ªåŠ¨é‡å»º Activity å¹¶é‡æ–°æ‰§è¡Œ `onCreate()`ï¼›
- èµ„æºæ–‡ä»¶ï¼ˆ`strings.xml`ï¼‰æ ¹æ®æ–°è¯­è¨€è‡ªåŠ¨åŠ è½½ï¼›
- Jetpack Compose ä¼šéš Activity é‡å»ºè€Œå®Œå…¨é‡ç»„ï¼Œ`stringResource()` è‡ªåŠ¨è·å–æ–°è¯­è¨€å­—ç¬¦ä¸²ï¼›

ç»“è®ºï¼šç³»ç»Ÿè¯­è¨€åˆ‡æ¢ä¸æ‰‹åŠ¨åˆ‡æ¢çš„æ ¸å¿ƒæœºåˆ¶ä¸€è‡´ï¼Œå‡ä¾èµ– â€œActivity é‡å»ºâ€ã€‚

---

## âœ… æ ¸å¿ƒç»“è®º

- æ‰‹åŠ¨è¯­è¨€åˆ‡æ¢å¿…é¡»ä½¿ç”¨ `Activity.recreate()` æ‰èƒ½è®©æ–°çš„ Locale ç”Ÿæ•ˆã€‚
- `applyLanguageSetting()` å¿…é¡»åœ¨ `super.onCreate()` ä¹‹å‰æ‰§è¡Œã€‚
- SYSTEM é€‰é¡¹ä¸‹ä¸è®¾ç½®ä»»ä½• Localeï¼Œä¾èµ–ç³»ç»Ÿé»˜è®¤è¡Œä¸ºå³å¯ã€‚

---

## ğŸ“ å®ç°æ¶æ„

### 1) æ•°æ®å±‚ï¼ˆä¸ç°æœ‰æ¶æ„ä¸€è‡´ï¼‰

å®šä¹‰è¯­è¨€æšä¸¾ï¼š`app/src/main/java/com/lhzkml/jasmine/ui/theme/Language.kt`

```kotlin
package com.lhzkml.jasmine.ui.theme

enum class AppLanguage {
    SYSTEM,              // è·Ÿéšç³»ç»Ÿ
    ENGLISH,             // è‹±è¯­
    SIMPLIFIED_CHINESE,  // ç®€ä½“ä¸­æ–‡
    TRADITIONAL_CHINESE  // ç¹ä½“ä¸­æ–‡
}
```

æŒä¹…åŒ–å­˜å‚¨ï¼ˆç¤ºä¾‹å…³é”®ç‚¹ï¼‰ï¼š

```kotlin
// PreferencesStore.ktï¼ˆç¤ºä¾‹å…³é”®ç‰‡æ®µï¼‰
val APP_LANGUAGE = stringPreferencesKey("app_language")

data class Settings(
    // ...
    val appLanguage: AppLanguage = AppLanguage.SYSTEM,
)

// è¯»å–
appLanguage = preferences[APP_LANGUAGE]?.let {
    AppLanguage.entries.firstOrNull { it.name == it } ?: AppLanguage.SYSTEM
} ?: AppLanguage.SYSTEM

// ä¿å­˜
preferences[APP_LANGUAGE] = settings.appLanguage.name
```

### 2) UI å±‚

Hookï¼š`app/src/main/java/com/lhzkml/jasmine/ui/hooks/AppLanguage.kt`

```kotlin
package com.lhzkml.jasmine.ui.hooks

import androidx.compose.runtime.Composable
import androidx.compose.runtime.MutableState
import androidx.compose.runtime.derivedStateOf
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import com.lhzkml.jasmine.ui.theme.AppLanguage

@Composable
fun rememberAppLanguage(): MutableState<AppLanguage> {
    var appLanguageValue by rememberSharedPreferenceString("app_language", "SYSTEM")
    val appLanguage by remember(appLanguageValue) {
        derivedStateOf {
            AppLanguage.entries.firstOrNull { it.name == appLanguageValue } ?: AppLanguage.SYSTEM
        }
    }
    return remember {
        object : MutableState<AppLanguage> {
            override var value: AppLanguage
                get() = appLanguage
                set(value) { appLanguageValue = value.name }

            override fun component1(): AppLanguage = value
            override fun component2(): (AppLanguage) -> Unit = { value = it }
        }
    }
}
```

è®¾ç½®é¡µ UI ç‰‡æ®µï¼ˆä½¿ç”¨ç°æœ‰ `Select` ç»„ä»¶ï¼‰ï¼š

```kotlin
item("app_language") {
    var appLanguage by rememberAppLanguage()
    val context = LocalContext.current

    ListItem(
        headlineContent = { Text(stringResource(R.string.setting_page_app_language)) },
        supportingContent = { Text(stringResource(R.string.setting_page_app_language_desc)) },
        leadingContent = { Icon(Lucide.Languages, null) },
        trailingContent = {
            Select(
                options = AppLanguage.entries,
                selectedOption = appLanguage,
                onOptionSelected = { newLanguage ->
                    appLanguage = newLanguage
                    // è¯­è¨€åˆ‡æ¢å¿…é¡»é€šè¿‡ Activity é‡å»º
                    (context as? Activity)?.recreate()
                },
                optionToString = {
                    when (it) {
                        AppLanguage.SYSTEM -> stringResource(R.string.language_system)
                        AppLanguage.ENGLISH -> stringResource(R.string.language_english)
                        AppLanguage.SIMPLIFIED_CHINESE -> stringResource(R.string.language_simplified_chinese)
                        AppLanguage.TRADITIONAL_CHINESE -> stringResource(R.string.language_traditional_chinese)
                    }
                },
                modifier = Modifier.width(180.dp)
            )
        }
    )
}
```

### 3) Activity å±‚ï¼ˆå…³é”®å®ç°ï¼‰

`RouteActivity.kt` ä¸­åœ¨ `onCreate` æœ€å‰è°ƒç”¨è¯­è¨€åº”ç”¨é€»è¾‘ï¼ˆSharedPreferences æ–‡ä»¶åç»Ÿä¸€ä¸º `"jasmine.preferences"`ï¼‰ï¼š

```kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    // å¿…é¡»åœ¨ super.onCreate() ä¹‹å‰åº”ç”¨è¯­è¨€è®¾ç½®
    applyLanguageSetting()

    enableEdgeToEdge()
    disableNavigationBarContrast()
    super.onCreate(savedInstanceState)
    // ... å…¶ä½™ä»£ç 
}

private fun applyLanguageSetting() {
    val prefs = getSharedPreferences("jasmine.preferences", MODE_PRIVATE)
    val languageValue = prefs.getString("app_language", "SYSTEM") ?: "SYSTEM"

    // åªæœ‰åœ¨é SYSTEM æ—¶æ‰åº”ç”¨è‡ªå®šä¹‰è¯­è¨€
    if (languageValue != "SYSTEM") {
        val locale = when (languageValue) {
            "ENGLISH" -> java.util.Locale.ENGLISH
            "SIMPLIFIED_CHINESE" -> java.util.Locale.SIMPLIFIED_CHINESE
            "TRADITIONAL_CHINESE" -> java.util.Locale.TRADITIONAL_CHINESE
            else -> return
        }

        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.N) {
            val localeList = android.os.LocaleList(locale)
            android.os.LocaleList.setDefault(localeList)

            val config = resources.configuration
            config.setLocales(localeList)
            createConfigurationContext(config)
        } else {
            java.util.Locale.setDefault(locale)
            val config = resources.configuration
            config.setLocale(locale)
            @Suppress("DEPRECATION")
            resources.updateConfiguration(config, resources.displayMetrics)
        }
    }
    // SYSTEMï¼šä¸åšä»»ä½•å¤„ç†ï¼Œè‡ªåŠ¨è·Ÿéšç³»ç»Ÿ
}
```

---

## âœ… å…¼å®¹æ€§æ ¸å¯¹ä¸ä¿®è®¢è¦ç‚¹

- SharedPreferencesï¼šæ–‡ä»¶åç»Ÿä¸€ä¸º `"jasmine.preferences"`ï¼›é”®åä¸º `"app_language"`ã€‚
- SYSTEM è¡Œä¸ºï¼šä¸è®¾ç½®ä»»ä½• Localeï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤è¯­è¨€ã€‚
- è¯­è¨€åˆ‡æ¢æœºåˆ¶ï¼šå¿…é¡»ä½¿ç”¨ `Activity.recreate()`ï¼Œä¸èƒ½ä½¿ç”¨å¯¼èˆªåˆ·æ–°æ›¿ä»£ï¼ˆä¸ ColorMode ä¸åŒï¼‰ã€‚
- Android 7.0+ï¼šä½¿ç”¨ `LocaleList` å¹¶è°ƒç”¨ `createConfigurationContext`ï¼›ä½ç‰ˆæœ¬ä½¿ç”¨ `Locale.setDefault()`ã€‚
- å¯¼å…¥è¯­å¥ï¼šç¡®ä¿åŒ…å« `Build`ã€`LocaleList`ã€`Locale` ç­‰å¿…è¦å¯¼å…¥ã€‚

ä»£ç æ£€æŸ¥æ¸…å•ï¼š
- [x] SharedPreferences æ–‡ä»¶åä¸€è‡´
- [x] Hook ä½¿ç”¨æ–¹å¼ç¬¦åˆç°æœ‰æ¨¡å¼
- [x] SYSTEM é€‰é¡¹æ­£ç¡®å¤„ç†ï¼ˆä¸è®¾ç½® Localeï¼‰
- [x] `applyLanguageSetting()` åœ¨ `super.onCreate()` ä¹‹å‰è°ƒç”¨
- [x] ä½¿ç”¨ `Activity.recreate()` é‡å¯ Activity
- [x] å…¼å®¹ Android 7.0+ çš„ `LocaleList` API

---

## ğŸŒ å›½é™…åŒ–èµ„æº

åœ¨ä¸‰å¥—è¯­è¨€èµ„æºæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å­—ç¬¦ä¸²ï¼š

`app/src/main/res/values/strings.xml`ï¼ˆè‹±è¯­ï¼‰ï¼š

```xml
<string name="setting_page_language_setting">Language Settings</string>
<string name="setting_page_app_language">App Language</string>
<string name="setting_page_app_language_desc">Choose the display language for the app</string>
<string name="language_system">ğŸŒ Follow System</string>
<string name="language_english">ğŸ‡¬ğŸ‡§ English</string>
<string name="language_simplified_chinese">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</string>
<string name="language_traditional_chinese">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</string>
```

`app/src/main/res/values-zh/strings.xml`ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰ï¼š

```xml
<string name="setting_page_language_setting">è¯­è¨€è®¾ç½®</string>
<string name="setting_page_app_language">åº”ç”¨è¯­è¨€</string>
<string name="setting_page_app_language_desc">é€‰æ‹©åº”ç”¨çš„æ˜¾ç¤ºè¯­è¨€</string>
<string name="language_system">ğŸŒ è·Ÿéšç³»ç»Ÿ</string>
<string name="language_english">ğŸ‡¬ğŸ‡§ English</string>
<string name="language_simplified_chinese">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</string>
<string name="language_traditional_chinese">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</string>
```

`app/src/main/res/values-zh-rTW/strings.xml`ï¼ˆç¹ä½“ä¸­æ–‡ï¼‰ï¼š

```xml
<string name="setting_page_language_setting">èªè¨€è¨­å®š</string>
<string name="setting_page_app_language">æ‡‰ç”¨ç¨‹å¼èªè¨€</string>
<string name="setting_page_app_language_desc">é¸æ“‡æ‡‰ç”¨ç¨‹å¼çš„é¡¯ç¤ºèªè¨€</string>
<string name="language_system">ğŸŒ è·Ÿéš¨ç³»çµ±</string>
<string name="language_english">ğŸ‡¬ğŸ‡§ English</string>
<string name="language_simplified_chinese">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</string>
<string name="language_traditional_chinese">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</string>
```

---

## ğŸ§ª éªŒè¯ä¸æµ‹è¯•

- ç³»ç»Ÿè¯­è¨€åˆ‡æ¢ï¼šéªŒè¯ Activity è‡ªåŠ¨é‡å»ºï¼Œèµ„æºæ­£ç¡®åŠ è½½ï¼ŒCompose é‡ç»„ã€‚
- æ‰‹åŠ¨è¯­è¨€åˆ‡æ¢ï¼šéªŒè¯ `(context as? Activity)?.recreate()` ç”Ÿæ•ˆï¼Œèµ„æºä¸ UI æ­£ç¡®åˆ·æ–°ã€‚
- æŒä¹…åŒ–éªŒè¯ï¼šé‡å¯åº”ç”¨åä»ä¿æŒç”¨æˆ·é€‰æ‹©ã€‚
- å…¼å®¹æ€§éªŒè¯ï¼šAndroid 7.0+ ä¸æ›´ä½ç‰ˆæœ¬çš„è¡Œä¸ºä¸€è‡´ã€‚

ç”¨æˆ·ä½“éªŒï¼š
- é‡å»ºæ—¶é—´çº¦ 0.3-0.8 ç§’ï¼›å¯èƒ½å‡ºç°çŸ­æš‚ç™½å±æˆ–ä¸»é¢˜è‰²é—ªçƒï¼›ä¸ç³»ç»Ÿè¯­è¨€åˆ‡æ¢ä½“éªŒä¸€è‡´ã€‚

---

## ğŸ”§ å®æ–½æ­¥éª¤æ€»ç»“

1. åˆ›å»ºè¯­è¨€æšä¸¾ï¼ˆ`Language.kt`ï¼‰ã€‚
2. æ·»åŠ æ•°æ®æŒä¹…åŒ–ï¼ˆä¿®æ”¹ `PreferencesStore.kt`ï¼‰ã€‚
3. åˆ›å»ºè¯­è¨€é€‰æ‹© Hookï¼ˆ`AppLanguage.kt`ï¼‰ã€‚
4. æ·»åŠ è®¾ç½®é¡µé¢ UIï¼ˆä¿®æ”¹ `SettingDisplayPage.kt`ï¼‰ã€‚
5. ä¿®æ”¹ `RouteActivity`ï¼Œåœ¨ `super.onCreate()` å‰è°ƒç”¨ `applyLanguageSetting()`ã€‚
6. æ·»åŠ ä¸‰å¥—å›½é™…åŒ–å­—ç¬¦ä¸²èµ„æºã€‚

---

## âœ… æœ€ç»ˆç»“è®º

1. æ‰‹åŠ¨è¯­è¨€åˆ‡æ¢ä¸ç³»ç»Ÿè¯­è¨€åˆ‡æ¢çš„æ ¸å¿ƒæœºåˆ¶ä¸€è‡´ï¼šå‡ä¸º Activity é‡å»ºã€‚
2. æ­£ç¡®å®ç°å¿…é¡»ä½¿ç”¨ `Activity.recreate()`ï¼Œå¹¶åœ¨ `super.onCreate()` å‰åº”ç”¨è¯­è¨€è®¾ç½®ã€‚
3. SYSTEM é€‰é¡¹æ— éœ€ä»»ä½•ä»£ç å¹²é¢„ï¼Œä¿æŒç³»ç»Ÿé»˜è®¤è¡Œä¸ºå³å¯ã€‚

---

## ğŸ—“ï¸ å…ƒä¿¡æ¯

- åˆ†æ/æ ¸å¯¹/æ–¹æ¡ˆåˆ›å»ºæ—¥æœŸï¼š2025-11-30
- ä¸ç°æœ‰ä»£ç å…¼å®¹æ€§ï¼š100%

